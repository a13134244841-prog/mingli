<script>
async function sendMessage() {
    const input = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const text = input.value.trim();
    if (!text) return;

    // 1. 显示你的消息
    chatBox.innerHTML += `<div class="text-right mb-4"><p class="bg-blue-600 text-white p-3 rounded-lg inline-block text-left">${text}</p></div>`;
    input.value = "";
    chatBox.scrollTop = chatBox.scrollHeight;

    // 2. 显示“大师正在推演...”
    const loadingId = "loading-" + Date.now();
    chatBox.innerHTML += `<div id="${loadingId}" class="text-left mb-4"><p class="bg-gray-200 p-3 rounded-lg inline-block">大师正在排盘推演...</p></div>`;

    try {
        // 3. 呼叫云函数
        const response = await fetch('/.netlify/functions/chat', {
            method: 'POST',
            body: JSON.stringify({ message: text }),
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        document.getElementById(loadingId).remove(); // 移除加载状态

        // 4. 显示 AI 回复
        chatBox.innerHTML += `<div class="text-left mb-4"><p class="bg-white border p-3 rounded-lg inline-block shadow-sm">${data.reply || data.error}</p></div>`;
    } catch (e) {
        document.getElementById(loadingId).innerHTML = `<p class="bg-red-100 text-red-700 p-3 rounded-lg inline-block">连接中断，请检查网络或配置。</p>`;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>
